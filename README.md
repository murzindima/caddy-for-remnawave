# Caddy for Remnawave

Обратный прокси для Remnawave на основе Caddy. Предоставляется два варианта конфигурации:
1. Multi-port: Xray на 443 порту, панель и подписки на кастомных портах
2. Xray-proxy: Вся маршрутизация через Remnawave ноду на 443 порту

## Общие шаги установки

Для всех вариантов конфигурации необходимо выполнить следующие шаги:

1. Склонируйте репозиторий:

```bash
git clone https://github.com/xxphantom/caddy-for-remnawave.git
cd caddy-for-remnawave
```

2. Скопируйте файл .env.sample и отредактируйте файл `.env`:

```bash
cp .env.sample .env
vim .env
```

## Вариант 1: Multi-port конфигурация, панель и подписки на кастомных портах

В этой конфигурации панель и подписки запускаются на кастомных портах, а Xray на 443 порту. Также предоставляется selfsteal заглушка, вам осталось отредактировать .env и (желательно) поменять статику в папкe `html` на свою. В конфиге Xray в панели указать inbounds -> port на 443 порту, а streamSettings.dest должен указывать на порт локальной selfsteal заглушки. В поле serverNames должен быть указан домен selfsteal заглушки.

### Установка и запуск

1. Выполните общие шаги установки, описанные выше

2. Запустите проект:

```bash
docker compose up -d && docker compose logs -f -t
```

## Вариант 2: Запуск всех сервисов на 443 порту с помощью локальной Remnawave ноды

В этой конфигурации Remnawave нода обрабатывает весь входящий трафик на 443 порту. Все запросы, которые не являются Xray-proxy-соединениями уходят в dest fallback и перенаправляются в Caddy, который затем распределяет их по нужным сервисам (панель, selfsteal, подписки в зависимости от sni). 

ВАЖНО! Для того, чтобы этот вариант конфигурации заработал, требуется сначала запустить панель на кастомном порту (первый вариант), установить и настроить локальную Remnawave ноду, в конфиге Xray в панели указать inbounds.port на 443 порту.

### Установка и запуск

1. Выполните общие шаги установки, описанные выше

2. Запустите проект с конфигурацией:

```bash
docker compose -f docker-compose.xray-proxy.yml up -d && docker compose logs -f -t
```

В этой конфигурации:
- Remnawave нода обрабатывает весь трафик на 443 порту
- Не-Xray-proxy запросы передаются в Caddy
- Caddy обрабатывает веб-трафик (панель, selfsteal, подписки)

## Вариант 3: Запуск ноды remnawave без панели (панель уже запущена на другом сервере)

В этом варианте Caddy обслуживает только selfsteal заглушку.

### Установка и запуск

1. Выполните общие шаги установки, описанные выше. 

2. Запустите проект:

```bash
docker compose -f docker-compose.selfsteal.yml up -d && docker compose logs -f -t
```
В этой конфигурации:
- Remnawave нода обрабатывает весь трафик на 443 порту
- Не-Xray-proxy запросы передаются в Caddy
- Caddy обрабатывает трафик, возвращая selfsteal заглушку

## Вариант 4: Запуск Remnawave панели без ноды, все ноды будут на других серверах

1. Выполните общие шаги установки, описанные выше

2. Запустите проект:

```bash
docker compose -f docker-compose.panel-only.yml up -d && docker compose logs -f -t
```

В этой конфигурации:
- Рекомендуется в .env указать 443 порт как для панели и подписок
- Сaddy выступает обратным прокси для панели и подписок, без selfsteal заглушки