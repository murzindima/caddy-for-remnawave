# Caddy for Remnawave

Обратный прокси для Remnawave на основе Caddy. Предоставляется 4 варианта конфигурации:

1. Multi-port: Xray на 443 порту, панель и подписки на кастомных портах, есть selfsteal
2. all-in-one-port: Вся маршрутизация через Remnawave ноду на 443 порту, есть selfsteal
3. Selfsteal-for-node-only: Запуск ноды Remnawave без панели (только selfsteal)
4. Panel-only: Запуск Remnawave панели без ноды, все ноды будут на других серверах

## Общие шаги установки

Для всех вариантов конфигурации необходимо выполнить следующие шаги:

1. Склонируйте репозиторий:

```bash
git clone https://github.com/xxphantom/caddy-for-remnawave.git
cd caddy-for-remnawave

# Установка зависимостей (для работы команд make)
apt-get update
apt-get install -y make
```

## Доступные команды Makefile

Для каждого варианта конфигурации доступны следующие команды Makefile:

```bash
# Запуск контейнеров
make start

# Остановка контейнеров
make stop

# Перезапуск контейнеров
make restart

# Просмотр логов
make logs
```

Эти команды являются удобными алиасами для соответствующих docker-compose команд, можете посмотреть их в Makefile.

## Вариант 1: Панель и нода на одной машине, панель и подписки на кастомных портах

В этой конфигурации панель и подписки запускаются на кастомных портах, а Xray на 443 порту. Также предоставляется selfsteal заглушка, вам осталось отредактировать .env и (желательно) поменять статику в папкe `html` на свою. В конфиге Xray в панели указать inbounds -> port на 443 порту, а streamSettings.dest должен указывать на порт локальной selfsteal заглушки. В поле serverNames должен быть указан домен selfsteal заглушки.

### Установка и запуск

1. Перейдите в директорию `multi-port`:

```bash
cd multi-port
```

2. Скопируйте файл .env.sample и отредактируйте файл `.env`:

```bash
cp .env.sample .env
vim .env
```

3. Запустите проект:

```bash
make start
```

## Вариант 2: Всe сервисы доступны на 443 порту через Xray (с помощью локальной Remnawave ноды)

В этой конфигурации Remnawave нода (Xray в ней) обрабатывает весь входящий трафик на 443 порту. Все запросы, которые не являются Xray-proxy-соединениями уходят в dest fallback и перенаправляются в Caddy, который затем распределяет их по нужным сервисам (панель, selfsteal, подписки в зависимости от sni). Если в этом режиме остановить локальную Remnawave ноду, то панель перестанет быть доступна.

ВАЖНО! Для того, чтобы этот вариант конфигурации заработал, требуется сначала запустить панель на кастомном порту (первый вариант), установить и настроить локальную Remnawave ноду, в конфиге Xray в панели указать inbounds.port на 443 порту. Иначе нода не сможет обработать входящий трафик.

### Установка и запуск

1. Перейдите в директорию `all-in-one-port`:

```bash
cd all-in-one-port
```

2. Скопируйте файл .env.sample и отредактируйте файл `.env`:

```bash
cp .env.sample .env
vim .env
```

3. Запустите проект:

```bash
make start
```

В этой конфигурации:

- Remnawave нода обрабатывает весь трафик на 443 порту
- Не-Xray-proxy запросы передаются в Caddy
- Caddy обрабатывает веб-трафик (панель, selfsteal, подписки)

## Вариант 3: Запуск только selfsteal заглушки

В этом варианте Caddy обслуживает только selfsteal заглушку, а панель запущена на другом сервере.

### Установка и запуск

1. Перейдите в директорию `selfsteal-for-node-only`:

```bash
cd selfsteal-for-node-only
```

2. Скопируйте файл .env.sample и отредактируйте файл `.env`:

```bash
cp .env.sample .env
vim .env
```

3. Запустите проект:

```bash
make start
```

В этой конфигурации:

- Remnawave нода обрабатывает весь трафик на 443 порту
- Не-Xray-proxy запросы передаются в Caddy
- Caddy обрабатывает трафик, возвращая selfsteal заглушку

## Вариант 4: Запуск обратного прокси только для Remnawave панели

В этом варианте запускается только панель Remnawave без локальной ноды. Все ноды будут на других серверах. Caddy обрабатывает трафик для панели и подписок.

### Установка и запуск

1. Перейдите в директорию `panel-only`:

```bash
cd panel-only
```

2. Скопируйте файл .env.sample и отредактируйте файл `.env`:

```bash
cp .env.sample .env
vim .env
```

3. Запустите проект:

```bash
make start
```

В этой конфигурации:

- Рекомендуется в .env указать 443 порт как для панели и подписок
- Сaddy выступает обратным прокси для панели и подписок, без selfsteal заглушки
